<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Dashboard</title>
</head>
<body>

<h1>Welcome to Dashboard ðŸŽ‰</h1>
<p id="expiryInfo"></p>
<button onclick="logout()">Logout</button>

<script type="module">

import { initializeApp } from "https://www.gstatic.com/firebasejs/12.10.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut }
from "https://www.gstatic.com/firebasejs/12.10.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAqVGxE6pQa8aWI4qHRpl93u7SdViKoaEc",
  authDomain: "login-setup-2230f.firebaseapp.com",
  projectId: "login-setup-2230f",
  storageBucket: "login-setup-2230f.firebasestorage.app",
  messagingSenderId: "764529433359",
  appId: "1:764529433359:web:490674f6f7a045f092bc7a",
  measurementId: "G-8B2S3PV42R"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);

// ðŸŽ¯ STEP 1 â€” Handle payment success FIRST
const params = new URLSearchParams(window.location.search);
const status = params.get("status");

if(status === "SUCCESS"){

    const duration = localStorage.getItem("selectedPlanDays");

    if(duration){

        const oldExpiry = localStorage.getItem("subscriptionExpiry");
        let baseDate = new Date();

        // If still active, extend from old expiry
        if(oldExpiry && new Date(oldExpiry) > new Date()){
            baseDate = new Date(oldExpiry);
        }

        baseDate.setDate(baseDate.getDate() + parseInt(duration));

        localStorage.setItem("subscriptionExpiry", baseDate.toISOString());
        localStorage.removeItem("selectedPlanDays");

        // Clean URL
        window.history.replaceState({}, document.title, "temp-dash.html");

        alert("Subscription Activated ðŸŽ‰");
    }
}

// ðŸ” STEP 2 â€” Now protect dashboard
onAuthStateChanged(auth, (user) => {

  if (!user) {
      window.location.href = "index.html";
      return;
  }

  const expiry = localStorage.getItem("subscriptionExpiry");

  if(!expiry || new Date() > new Date(expiry)){
      window.location.href = "payment.html";
      return;
  }

  document.getElementById("expiryInfo").innerText =
      "Subscription valid until: " + new Date(expiry).toDateString();
});

window.logout = function(){
  signOut(auth);
  window.location.href = "index.html";
};

</script>